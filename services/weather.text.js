// ======================================================
// æ¯›æ€ªå¤©æ°£æ–‡æ¡ˆæ¨¡çµ„ï½œæœ‹å‹å˜´ç ²ç‰ˆ v1.2ï¼ˆç©©å®šé˜²ç‚¸ç‰ˆï¼‰
// ======================================================

function pick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function getTempFeeling(t) {
  if (t <= 18) return "æœ‰é»å†·";
  if (t <= 23) return "åæ¶¼";
  if (t <= 27) return "ç®—èˆ’æœ";
  if (t <= 31) return "æœ‰é»ç†±";
  return "æ»¿ç†±çš„";
}

function isNight() {
  const h = new Date().getHours();
  return h >= 18 || h < 6;
}

// å®‰å…¨å– weatherElement å…§è³‡æ–™
function getElement(elements, name, fallback = "") {
  try {
    return (
      elements.find(e => e.elementName === name)
        ?.time?.[0]?.parameter?.parameterName
    ) || fallback;
  } catch {
    return fallback;
  }
}

function buildWeatherFriendText(weather) {
  // ===============================
  // ğŸ”’ çµæ§‹é˜²å‘†ï¼ˆé—œéµï¼‰
  // ===============================
  if (!weather) {
    return "å¤©æ°£è³‡æ–™æš«æ™‚æ€ªæ€ªçš„ï¼Œç­‰ç­‰å†è©¦ã€‚";
  }

  const city = weather.city || "æœªçŸ¥åœ°å€";

  // âš ï¸ çœŸæ­£çš„ location ç‰©ä»¶
  const location = weather.data || weather.location;

  if (!location || !Array.isArray(location.weatherElement)) {
    return `${city} å¤©æ°£è³‡æ–™æš«æ™‚æŠ“ä¸åˆ°ï¼Œæ™šé»å†çœ‹ã€‚`;
  }

  const elements = location.weatherElement;

  const wx = getElement(elements, "Wx", "å¤©æ°£ä¸æ˜");
  const pop = Number(getElement(elements, "PoP", 0));
  const tMin = Number(getElement(elements, "MinT", 0));
  const tMax = Number(getElement(elements, "MaxT", 0));

  const tempFeeling = getTempFeeling(tMax);
  const night = isNight();

  let maoLine = "";

  // ======================================================
  // ğŸŒ§ï¸ é™é›¨æ©Ÿç‡åˆ†ç´šï¼ˆä½ å®šç¨¿çš„é‚è¼¯ï¼‰
  // ======================================================
  if (pop <= 20) {
    maoLine = pick([
      "åŸºæœ¬ä¸Šä¸å¤ªæœƒä¸‹ï¼Œè¦ä¸è¦ç®¡éš¨ä½ ã€‚",
      "é›¨æ˜¯æ²’ä»€éº¼æ©Ÿæœƒå•¦ï¼Œä»Šå¤©å¯ä»¥æ”¾é¬†ä¸€é»ã€‚",
      "çœ‹èµ·ä¾†ç®—å®‰å…¨ï¼Œæ‡¶å¾—å¸¶å‚˜ä¹Ÿä¸å¤ªæœƒå‡ºäº‹ã€‚"
    ]);
  } else if (pop <= 39) {
    maoLine = pick([
      "æœ‰ä¸€é»é»æ©Ÿç‡ï¼Œä½†ä¸ç”¨è‡ªå·±åš‡è‡ªå·±ã€‚",
      "æƒ³å¸¶å‚˜ä¹Ÿè¡Œï¼Œä¸å¸¶å…¶å¯¦ä¹Ÿèªªå¾—éå»ã€‚",
      "ä¸æ˜¯å®Œå…¨ä¸æœƒä¸‹ï¼Œä½†æ©Ÿç‡ä¸é«˜ã€‚"
    ]);
  } else if (pop <= 60) {
    maoLine = pick([
      "ä¸‹ä¸ä¸‹ä¸å¥½èªªï¼Œè¦ä¸è¦è½éš¨ä½ ï¼Œä½†æˆ‘æœ‰è¬›ã€‚",
      "é€™ç¨®ä¸ä¸Šä¸ä¸‹çš„æ©Ÿç‡æœ€ç…©ï¼Œç­‰ç­‰çªç„¶ä¸‹ä¹Ÿä¸å¥‡æ€ªã€‚",
      "ç¾åœ¨çœŸçš„çœ‹ä¸å¤ªæº–ï¼Œæœƒä¸æœƒä¸‹ä¸å¥½èªªã€‚"
    ]);
  } else if (pop <= 80) {
    maoLine = pick([
      "é€™å€‹æ©Ÿç‡æˆ‘æœƒç•¶ä½œæœƒä¸‹å•¦ï¼Œä½ è‡ªå·±æƒ³ä¸€ä¸‹ã€‚",
      "ä¸æƒ³æ·‹é›¨çš„è©±ï¼Œä»Šå¤©å°±ä¸è¦è³­ã€‚",
      "é›¨çš„å­˜åœ¨æ„Ÿå·²ç¶“æœ‰é»é«˜äº†ã€‚"
    ]);
  } else {
    maoLine = pick([
      "ä¸ç”¨å¹»æƒ³äº†ï¼Œé€™å€‹å°±æ˜¯æœƒä¸‹ã€‚",
      "é€™ç¨®æ©Ÿç‡é‚„æƒ³è³­ä¸ä¸‹é›¨ï¼Œæˆ‘æ˜¯è¦ºå¾—å¾ˆå‹‡ã€‚",
      "åŸºæœ¬ä¸Šå°±æ˜¯ä¸‹å¥½ä¸‹æ»¿ã€‚"
    ]);
  }

  // ======================================================
  // ğŸŒ¡ï¸ æº«åº¦è£œå˜´ï¼ˆä¸æ¶ä¸»æˆ²ï¼‰
  // ======================================================
  if (tMax >= 28 && pop >= 40) {
    maoLine += " åˆç†±åˆå¯èƒ½ä¸‹é›¨ï¼Œé€™ç¨®æœ€å®¹æ˜“è®“äººç…©ã€‚";
  } else if (tMax >= 28) {
    maoLine += ` å¦å¤–æé†’ä¸€ä¸‹ï¼Œä»Šå¤©${tempFeeling}ã€‚`;
  } else if (tMax <= 18) {
    maoLine += " æº«åº¦åä½ï¼Œè¨˜å¾—ä¸è¦è‘—æ¶¼ã€‚";
  }

  // ======================================================
  // ğŸŒ™ æ™šä¸Šèªæ°£
  // ======================================================
  if (night) {
    maoLine += " æ™šä¸Šè¦ä¸è¦å‡ºé–€ï¼Œä½ è‡ªå·±è©•ä¼°ã€‚";
  }

  return `ã€æ¯›æ€ªå¤©æ°£ ğŸŒ§ï¸ã€‘
â”â”â”â”â”â”â”â”â”â”â”
${city}ï½œ${wx}

ğŸ’§ é™é›¨çš„æ©Ÿç‡ ${pop}%
ğŸŒ¡ï¸ æ°£æº« ${tMin}ï½${tMax}Â°C

ğŸ˜ˆ æ¯›æ€ªèªªä¸€å¥ï¼š
${maoLine}`;
}

module.exports = {
  buildWeatherFriendText
};
