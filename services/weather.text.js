// ======================================================
// æ¯›æ€ªå¤©æ°£æ–‡æ¡ˆæ¨¡çµ„ï½œæ­£å¼ç‰ˆ v1.3
// - é™é›¨ç‚ºä¸»ç·š
// - æº«åº¦é«”æ„Ÿéš¨æ©Ÿå˜´ç ²
// - æƒ…å¢ƒå˜´ç ² & ç‰¹æ®Šå¤©æ°£å¼·åŒ–
// - ç›¸å®¹ CWA æ–°èˆŠæ ¼å¼
// ======================================================

function pick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function isNight() {
  const h = new Date().getHours();
  return h >= 18 || h < 6;
}

// ======================================================
// æº«åº¦åˆ†ç´š
// ======================================================
function getTempLevel(tMax) {
  if (tMax <= 18) return "cold";
  if (tMax <= 23) return "cool";
  if (tMax <= 27) return "nice";
  if (tMax <= 31) return "warm";
  return "hot";
}

// ======================================================
// æº«åº¦å˜´ç ²å¥åº«ï¼ˆå®šç‰ˆï¼‰
// ======================================================
const TEMP_LINES = {
  cold: [
    "ä»Šå¤©åå†·ï¼Œç©¿å°‘ä¸€é»çœŸçš„æœƒå¾Œæ‚”ã€‚",
    "é€™æº«åº¦ä¸æ˜¯åœ¨è·Ÿä½ å®¢æ°£çš„ï¼Œè‡ªå·±æ³¨æ„ä¸€ä¸‹ã€‚",
    "ä¸å†·æ˜¯ä¸å¯èƒ½çš„ï¼Œè‡ªå·±ä¿é‡ã€‚"
  ],
  cool: [
    "æœ‰é»æ¶¼ï¼Œæ—©æ™šå¯èƒ½æœƒæƒ³åŠ ä»¶å¤–å¥—ã€‚",
    "é¢¨ä¾†çš„æ™‚å€™æœƒæœ‰æ„Ÿè¦ºé‚£ç¨®æ¶¼ã€‚",
    "ä¸ç®—å†·ï¼Œä½†ä¹Ÿä¸æ˜¯çŸ­è¢–éš¨ä¾¿ç©¿çš„å¤©æ°£ã€‚"
  ],
  nice: [
    "æº«åº¦å…¶å¯¦è »å‰›å¥½çš„ã€‚",
    "é€™ç¨®å¤©æ°£åŸºæœ¬ä¸Šä¸æœƒè®“äººä¸çˆ½ã€‚",
    "ä¸å†·ä¸ç†±ï¼Œç®—æ˜¯é›£å¾—æ­£å¸¸çš„ä¸€å¤©ã€‚"
  ],
  warm: [
    "é–‹å§‹æœ‰é»æ‚¶äº†ï¼Œå‹•ä¸€å‹•å°±æœƒæµæ±—ã€‚",
    "ä¸è‡³æ–¼çˆ†ç‚¸ï¼Œä½†æœƒé–‹å§‹è¦ºå¾—ç…©ã€‚",
    "é€™æº«åº¦å·²ç¶“ä¸æ˜¯å¯ä»¥å¿½ç•¥çš„é‚£ç¨®ã€‚"
  ],
  hot: [
    "é€™å·²ç¶“ä¸æ˜¯ç†±ï¼Œæ˜¯åœ¨è€ƒé©—è€å¿ƒã€‚",
    "å‡ºé–€æ²’å¿ƒç†æº–å‚™æœƒç›´æ¥ä¸çˆ½ã€‚",
    "ä»Šå¤©æœƒç†±åˆ°è®“äººæ‡·ç–‘äººç”Ÿã€‚"
  ]
};

// ======================================================
// æƒ…å¢ƒ / ç‰¹æ®Šå¤©æ°£å˜´ç ²
// ======================================================
const SCENE_LINES = {
  unsureRain: [
    "é€™ç¨®æ©Ÿç‡å°±æ˜¯å°ˆé–€æäººçš„ã€‚",
    "ä¸å¸¶å‚˜æœƒè³­ï¼Œå¸¶å‚˜åˆè¦ºå¾—è‡ªå·±å¾ˆè ¢ã€‚",
    "å¤©æ°£åœ¨é‚£é‚ŠçŒ¶è±«ï¼Œä½ ä¹Ÿæœƒè·Ÿè‘—çŒ¶è±«ã€‚"
  ],
  rain: [
    "é€™ä¸æ˜¯å‡é›¨ï¼Œæ˜¯æœƒè®“ä½ çœŸçš„æ¿•çš„é‚£ç¨®ã€‚",
    "ä»Šå¤©ä¸å¤ªé©åˆè³­é‹æ°£ã€‚",
    "å‡ºé–€åŸºæœ¬ä¸Šå°±æ˜¯è¦æœ‰å¿ƒç†æº–å‚™ã€‚"
  ],
  thunder: [
    "é€™ç¨®å¤©æ°£ä¸æ˜¯ä¸‹é›¨ï¼Œæ˜¯åœ¨äº‚ä¸‹ã€‚",
    "é›·é›¨å¤©å‡ºé–€é€šå¸¸ä¸æœƒæœ‰å¥½ä¸‹å ´ã€‚",
    "ä¸€ä¸‹å¤§ä¸€ä¸‹åœï¼Œæœ€é›£æçš„é‚£ç¨®ã€‚"
  ],
  fog: [
    "è¦–ç·šä¸å¤ªå¥½ï¼Œä»Šå¤©å¤–å‡ºè‡ªå·±å°å¿ƒã€‚",
    "é€™ç¨®å¤©æ°£æœ€å®¹æ˜“è®“äººç²¾ç¥å¾ˆå·®ã€‚",
    "çœ‹èµ·ä¾†æ²’äº‹ï¼Œå…¶å¯¦å¾ˆå½±éŸ¿ç‹€æ…‹ã€‚"
  ],
  hotRain: [
    "åˆç†±åˆå¯èƒ½ä¸‹é›¨ï¼Œä»Šå¤©åŸºæœ¬ä¸Šä¸æœƒå¥½éã€‚",
    "é€™ç¨®å¤©æ°£å°±æ˜¯å…¨æ–¹ä½çš„ä¸èˆ’æœã€‚",
    "ä¸ç®¡ä½ è¦å¹¹å˜›ï¼Œä»Šå¤©éƒ½æœƒè¢«å¤©æ°£å¹²æ“¾ã€‚"
  ],
  coldRain: [
    "å†·åŠ ä¸Šä¸‹é›¨ï¼Œé«”æ„Ÿç›´æ¥å¾€ä¸‹ä¿®ã€‚",
    "é€™ç¨®å¤©æ°£æœ€å®¹æ˜“è®“äººå¿ƒæƒ…ä¸å¥½ã€‚",
    "å¤–å‡ºæ˜¯çœŸçš„è¦æœ‰å¿ƒç†æº–å‚™ã€‚"
  ]
};

// ======================================================
// æŠ½å– weatherElementï¼ˆæ–°èˆŠ CWA ç›¸å®¹ï¼‰
// ======================================================
function extractWeatherElement(weather) {
  if (!weather) return null;

  const records = weather.data?.records || weather.records;
  if (Array.isArray(records?.location) && records.location[0]?.weatherElement) {
    return records.location[0].weatherElement;
  }

  if (Array.isArray(weather.data?.weatherElement)) {
    return weather.data.weatherElement;
  }

  if (Array.isArray(weather.weatherElement)) {
    return weather.weatherElement;
  }

  return null;
}

// ======================================================
// å–å–®ä¸€æ°£è±¡å…ƒç´ 
// ======================================================
function getElement(elements, name, fallback = "") {
  if (!elements) return fallback;

  const el = elements.find(e => e.elementName === name);
  if (!el || !Array.isArray(el.time) || !el.time[0]) return fallback;

  const t = el.time[0];
  return (
    t.elementValue?.[0]?.value ??
    t.parameter?.parameterName ??
    fallback
  );
}

// ======================================================
// ä¸»è¼¸å‡º
// ======================================================
function buildWeatherFriendText(weather) {
  const city =
    weather?.city ||
    weather?.data?.records?.location?.[0]?.locationName ||
    "é€™å€‹åœ°æ–¹";

  const elements = extractWeatherElement(weather);
  if (!elements) {
    return `ã€æ¯›æ€ªå¤©æ°£ ğŸŒ§ï¸ã€‘
â”â”â”â”â”â”â”â”â”â”â”
${city}

å¤©æ°£è³‡æ–™æš«æ™‚æŠ“ä¸åˆ°ï¼Œæ™šé»å†çœ‹ã€‚`;
  }

  const wx = getElement(elements, "Wx", "å¤©æ°£ä¸æ˜");
  const pop = Number(getElement(elements, "PoP", 0));
  const tMin = Number(getElement(elements, "MinT", 0));
  const tMax = Number(getElement(elements, "MaxT", 0));

  let maoLine = "";

  // ======================================================
  // é™é›¨ä¸»ç·š
  // ======================================================
  if (pop <= 20) {
    maoLine = pick([
      "åŸºæœ¬ä¸Šä¸å¤ªæœƒä¸‹ï¼Œè¦ä¸è¦ç®¡éš¨ä½ ã€‚",
      "é›¨æ˜¯æ²’ä»€éº¼æ©Ÿæœƒå•¦ï¼Œä»Šå¤©å¯ä»¥æ”¾é¬†ä¸€é»ã€‚"
    ]);
  } else if (pop <= 39) {
    maoLine = pick([
      "æœ‰ä¸€é»é»æ©Ÿç‡ï¼Œä½†ä¸ç”¨è‡ªå·±åš‡è‡ªå·±ã€‚",
      "æƒ³å¸¶å‚˜ä¹Ÿè¡Œï¼Œä¸å¸¶å…¶å¯¦ä¹Ÿèªªå¾—éå»ã€‚"
    ]);
  } else if (pop <= 60) {
    maoLine = pick([
      "ä¸‹ä¸ä¸‹ä¸å¥½èªªï¼Œè¦ä¸è¦è½éš¨ä½ ï¼Œä½†æˆ‘æœ‰è¬›ã€‚",
      "é€™ç¨®ä¸ä¸Šä¸ä¸‹çš„æ©Ÿç‡æœ€ç…©ã€‚"
    ]);
    maoLine += " " + pick(SCENE_LINES.unsureRain);
  } else if (pop <= 80) {
    maoLine = pick([
      "é€™å€‹æ©Ÿç‡æˆ‘æœƒç•¶ä½œæœƒä¸‹å•¦ï¼Œä½ è‡ªå·±æƒ³ä¸€ä¸‹ã€‚",
      "ä¸æƒ³æ·‹é›¨çš„è©±ï¼Œä»Šå¤©å°±ä¸è¦è³­ã€‚"
    ]);
  } else {
    maoLine = pick([
      "ä¸ç”¨å¹»æƒ³äº†ï¼Œé€™å€‹å°±æ˜¯æœƒä¸‹ã€‚",
      "é€™ç¨®æ©Ÿç‡é‚„æƒ³è³­ä¸ä¸‹é›¨ï¼Œæˆ‘æ˜¯è¦ºå¾—å¾ˆå‹‡ã€‚"
    ]);
  }

  // ======================================================
  // ç‰¹æ®Šå¤©æ°£é—œéµå­—
  // ======================================================
  if (/é›·/.test(wx)) {
    maoLine += " " + pick(SCENE_LINES.thunder);
  } else if (/é›¨/.test(wx) && pop >= 60) {
    maoLine += " " + pick(SCENE_LINES.rain);
  } else if (/éœ§/.test(wx)) {
    maoLine += " " + pick(SCENE_LINES.fog);
  }

  // ======================================================
  // æº«åº¦é«”æ„Ÿ
  // ======================================================
  if (tMax > 0) {
    if (tMax >= 28 && pop >= 40) {
      maoLine += " " + pick(SCENE_LINES.hotRain);
    } else if (tMax <= 18 && pop >= 40) {
      maoLine += " " + pick(SCENE_LINES.coldRain);
    } else {
      const level = getTempLevel(tMax);
      maoLine += " " + pick(TEMP_LINES[level]);
    }
  }

  // ======================================================
  // æ™šä¸Šè£œä¸€å¥
  // ======================================================
  if (isNight()) {
    maoLine += " æ™šä¸Šè¦ä¸è¦å‡ºé–€ï¼Œä½ è‡ªå·±è©•ä¼°ã€‚";
  }

  return `ã€æ¯›æ€ªå¤©æ°£ ğŸŒ§ï¸ã€‘
â”â”â”â”â”â”â”â”â”â”â”
${city}ï½œ${wx}

ğŸ’§ é™é›¨çš„æ©Ÿç‡ ${pop}%
ğŸŒ¡ï¸ æ°£æº« ${tMin}ï½${tMax}Â°C

ğŸ˜ˆ æ¯›æ€ªèªªä¸€å¥ï¼š
${maoLine}`;
}

module.exports = {
  buildWeatherFriendText
};
